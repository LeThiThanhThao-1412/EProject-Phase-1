name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:5.0
        ports:
          - 27017:27017

    steps:
    - name: Checkout code
      uses: actions/checkout@v3.2.0
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Wait for MongoDB
      run: |
        echo "Waiting for MongoDB to be ready..."
        sleep 15

    - name: Create .env files for testing
      run: |
        # Tạo .env cho auth với MongoDB local
        cat > auth/.env << EOF
        MONGODB_AUTH_URI=mongodb://localhost:27017/auth_test
        JWT_SECRET=test-jwt-secret-for-ci-cd-pipeline-12345
        PORT=3000
        NODE_ENV=test
        EOF
        
        # Tạo .env cho product với MongoDB local
        cat > product/.env << EOF
        JWT_SECRET=test-jwt-secret-for-ci-cd-pipeline-12345
        MONGODB_PRODUCT_URI=mongodb://localhost:27017/product_test
        LOGIN_TEST_USER=test@example.com
        LOGIN_TEST_PASSWORD=testpassword123
        AUTH_SERVICE_URL=http://localhost:3000
        PORT=3001
        NODE_ENV=test
        EOF

    - name: Install ALL dependencies
      run: |
        echo "Installing ALL dependencies including devDependencies..."
        
        # Auth service - cài đặt tất cả dependencies
        cd auth
        npm install
        cd ..
        
        # Product service - cài đặt tất cả dependencies  
        cd product
        npm install
        cd ..
        
    - name: Add health endpoint to auth service
      run: |
        echo "Adding health endpoint to auth service..."
        # Tạo file health endpoint tạm thời
        cat > auth/health.js << 'EOF'
        const express = require('express');
        const router = express.Router();
        
        router.get('/health', (req, res) => {
          res.status(200).json({ 
            status: 'OK', 
            service: 'auth',
            timestamp: new Date().toISOString()
          });
        });
        
        module.exports = router;
        EOF
        
        # Thêm health endpoint vào app.js của auth
        cd auth
        if grep -q "health" src/app.js; then
          echo "Health endpoint already exists"
        else
          # Tìm dòng có this.app.use(express.json()); và thêm health endpoint sau đó
          sed -i '/this.app.use(express.json())/a\    this.app.use(require("..\/health"));' src/app.js
        fi
        cd ..

    - name: Run tests for auth service
      run: |
        echo "Running auth tests..."
        cd auth
        npm test
        
    - name: Start auth service and prepare for product tests
      run: |
        echo "Starting auth service and preparing for product tests..."
        # Start auth service in background
        cd auth
        npm start &
        
        # Wait for auth service to be ready
        echo "Waiting for auth service to start..."
        sleep 30
        
        # Check auth service health
        echo "Checking auth service health..."
        curl -f http://localhost:3000/health || echo "Health endpoint check failed"
        
        # Tạo test user và lấy token
        echo "Creating test user and getting token..."
        
        # Đăng ký user test
        curl -X POST http://localhost:3000/register \
          -H "Content-Type: application/json" \
          -d '{"username":"test@example.com","password":"testpassword123"}' \
          --silent --show-error || echo "User might already exist"
        
        # Lấy token từ auth service
        echo "Getting auth token..."
        TOKEN_RESPONSE=$(curl -s -X POST http://localhost:3000/login \
          -H "Content-Type: application/json" \
          -d '{"username":"test@example.com","password":"testpassword123"}')
        
        echo "Token response: $TOKEN_RESPONSE"
        
        # Trích xuất token từ response
        TOKEN=$(echo "$TOKEN_RESPONSE" | grep -o '"token":"[^"]*' | cut -d'"' -f4)
        echo "Extracted token: $TOKEN"
        
        # Tạo file tạm chứa token để product test sử dụng
        echo "$TOKEN" > /tmp/auth_token.txt
        echo "Token saved to /tmp/auth_token.txt"
        
    - name: Run product tests with fixed token
      run: |
        echo "Running product tests..."
        cd product
        
        # Đọc token từ file
        AUTH_TOKEN=$(cat /tmp/auth_token.txt)
        echo "Using auth token: $AUTH_TOKEN"
        
        # Kiểm tra token có tồn tại không
        if [ -z "$AUTH_TOKEN" ]; then
          echo "ERROR: Auth token is empty!"
          exit 1
        fi
        
        # Chạy test với token đã fix
        AUTH_TOKEN="$AUTH_TOKEN" npm test

    - name: Cleanup
      if: always()
      run: |
        echo "Cleaning up..."
        pkill -f "node" || true
        rm -f /tmp/auth_token.txt